<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<body>

<th:block th:replace="~{fragments/layout :: page(title='Projets', content=~{::content})}">
<content>

  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a th:href="@{/dashboard}">Accueil</a>
    <span class="separator">â€º</span>
    <span class="current">Projets</span>
  </div>

  <!-- Toolbar -->
  <div class="flex-between mb-4">
    <div>
      <h2 style="font-family:var(--font-display);font-size:22px;font-weight:700">Projets de recherche</h2>
      <p class="text-muted text-sm mt-1"
         th:text="${projets.size()} + ' projet(s) trouvÃ©(s)'">0 projet(s)</p>
    </div>
    <div class="flex gap-2">
      <sec:authorize access="hasRole('ADMIN')">
        <a th:href="@{/admin/import}" class="btn btn-outline">ğŸ“¤ Importer CSV</a>
      </sec:authorize>
      <a th:href="@{/projets/nouveau}" class="btn btn-accent">+ Nouveau projet</a>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="Rechercher un projet..."/>
    </div>

    <select class="filter-select" id="filterStatut">
      <option value="">Tous les statuts</option>
      <option value="en_cours">En cours</option>
      <option value="termine">TerminÃ©</option>
      <option value="suspendu">Suspendu</option>
      <option value="planifie">PlanifiÃ©</option>
    </select>

    <select class="filter-select" id="filterDomaine">
      <option value="">Tous les domaines</option>
      <option th:each="p : ${projets}"
              th:if="${p.domaine != null}"
              th:value="${p.domaine.nom.toLowerCase()}"
              th:text="${p.domaine.nom}"
              th:selected="${false}">Domaine</option>
    </select>

    <!-- View toggle -->
    <div class="flex gap-2">
      <button class="btn btn-outline btn-icon" id="viewGrid" title="Vue grille">âŠ</button>
      <button class="btn btn-outline btn-icon" id="viewList" title="Vue liste">â˜°</button>
    </div>
  </div>

  <!-- Empty state -->
  <th:block th:if="${projets == null or projets.isEmpty()}">
    <div class="empty-state card">
      <div class="empty-icon">ğŸ“‚</div>
      <div class="empty-title">Aucun projet trouvÃ©</div>
      <div class="empty-desc">Commencez par crÃ©er votre premier projet de recherche</div>
      <a th:href="@{/projets/nouveau}" class="btn btn-primary">+ CrÃ©er un projet</a>
    </div>
  </th:block>

  <!-- Grid view (default) -->
  <div class="projets-grid" id="viewGridContent"
       th:if="${projets != null and !projets.isEmpty()}">

    <div class="projet-card fade-in"
         th:each="projet : ${projets}"
         th:data-searchable="true"
         th:data-statut="${projet.statut?.name()?.toLowerCase()}"
         th:data-domaine="${projet.domaine?.nom?.toLowerCase()}">

      <div class="projet-card-header">
        <div class="projet-card-domain" th:text="${projet.domaine?.nom ?: 'Sans domaine'}">Domaine</div>
        <div class="projet-card-title" th:text="${projet.titre}">Titre</div>
        <div class="projet-card-desc" th:text="${projet.description}">Description...</div>

        <span style="position:absolute;top:20px;right:20px"
              th:classappend="${projet.statut?.name() == 'EN_COURS'} ? 'badge-info' :
                              (${projet.statut?.name() == 'TERMINE'} ? 'badge-success' :
                              (${projet.statut?.name() == 'SUSPENDU'} ? 'badge-warning' : 'badge-gray'))"
              class="badge"
              th:text="${projet.statut}">Statut</span>
      </div>

      <div class="projet-card-body">
        <div class="projet-meta">
          <div class="projet-meta-item">
            <span class="icon">ğŸ‘¤</span>
            <span th:text="${projet.responsable?.nomComplet ?: 'Non assignÃ©'}">Responsable</span>
          </div>
          <div class="projet-meta-item" th:if="${projet.institution}">
            <span class="icon">ğŸ›ï¸</span>
            <span th:text="${projet.institution}">Institution</span>
          </div>
          <div class="projet-meta-item" th:if="${projet.dateDebut}">
            <span class="icon">ğŸ“…</span>
            <span th:text="${#temporals.format(projet.dateDebut, 'dd/MM/yyyy')}">Date</span>
          </div>
          <div class="projet-meta-item" th:if="${projet.budgetEstime}">
            <span class="icon">ğŸ’°</span>
            <span th:text="${#numbers.formatDecimal(projet.budgetEstime, 1, 'POINT', 0, 'COMMA')} + ' FCFA'">Budget</span>
          </div>
        </div>

        <!-- Progress -->
        <div class="flex-center gap-2">
          <div class="progress" style="flex:1">
            <div class="progress-bar"
                 th:classappend="${(projet.niveauAvancement ?: 0) >= 75} ? 'high' :
                                 (${(projet.niveauAvancement ?: 0) >= 40} ? 'medium' : 'low')"
                 th:style="'width:' + ${projet.niveauAvancement ?: 0} + '%'"></div>
          </div>
          <span class="text-sm font-mono"
                th:text="${projet.niveauAvancement ?: 0} + '%'">0%</span>
        </div>

        <!-- Participants -->
        <div class="participants-list mt-3" th:if="${projet.participants != null and !projet.participants.isEmpty()}">
          <div class="participant-chip"
               th:each="p, stat : ${projet.participants}"
               th:if="${stat.index < 3}">
            <div class="participant-avatar"
                 th:text="${p.nomComplet != null and !p.nomComplet.isEmpty()} ? ${p.nomComplet.substring(0,1).toUpperCase()} : '?'">P</div>
            <span th:text="${p.nomComplet}">Participant</span>
          </div>
          <div class="participant-chip" th:if="${projet.participants.size() > 3}"
               style="color:var(--text-muted)">
            +<span th:text="${projet.participants.size() - 3}">0</span>
          </div>
        </div>
      </div>

      <div class="projet-card-footer">
        <a th:href="@{/projets/{id}(id=${projet.id})}" class="btn btn-outline btn-sm">Voir dÃ©tail</a>
        <div class="flex gap-2">
          <a th:href="@{/projets/{id}/modifier(id=${projet.id})}" class="btn btn-primary btn-sm">âœï¸ Modifier</a>
          <sec:authorize access="hasRole('ADMIN')">
            <form th:action="@{/projets/{id}/supprimer(id=${projet.id})}" method="post" style="display:inline">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button type="submit"
                      class="btn btn-danger btn-sm"
                      data-confirm="Supprimer ce projet dÃ©finitivement ?">ğŸ—‘ï¸</button>
            </form>
          </sec:authorize>
        </div>
      </div>

    </div>
  </div>

  <!-- List view (hidden by default) -->
  <div class="card" id="viewListContent" style="display:none"
       th:if="${projets != null and !projets.isEmpty()}">
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Titre</th>
            <th>Domaine</th>
            <th>Statut</th>
            <th>Avancement</th>
            <th>Responsable</th>
            <th>Budget</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="projet : ${projets}"
              th:data-searchable="true"
              th:data-statut="${projet.statut?.name()?.toLowerCase()}"
              th:data-domaine="${projet.domaine?.nom?.toLowerCase()}">
            <td>
              <a th:href="@{/projets/{id}(id=${projet.id})}"
                 style="font-weight:500;color:var(--primary)"
                 th:text="${projet.titre}">Titre</a>
              <div class="text-sm text-muted" th:text="${projet.institution}"></div>
            </td>
            <td><span class="badge badge-accent" th:text="${projet.domaine?.nom ?: '-'}">-</span></td>
            <td>
              <span th:classappend="${projet.statut?.name() == 'EN_COURS'} ? 'badge-info' :
                                    (${projet.statut?.name() == 'TERMINE'} ? 'badge-success' :
                                    (${projet.statut?.name() == 'SUSPENDU'} ? 'badge-warning' : 'badge-gray'))"
                    class="badge" th:text="${projet.statut}">-</span>
            </td>
            <td style="min-width:140px">
              <div class="flex-center gap-2">
                <div class="progress" style="flex:1">
                  <div class="progress-bar"
                       th:classappend="${(projet.niveauAvancement ?: 0) >= 75} ? 'high' :
                                       (${(projet.niveauAvancement ?: 0) >= 40} ? 'medium' : 'low')"
                       th:style="'width:' + ${projet.niveauAvancement ?: 0} + '%'"></div>
                </div>
                <span class="text-sm font-mono"
                      th:text="${projet.niveauAvancement ?: 0} + '%'">0%</span>
              </div>
            </td>
            <td class="text-sm" th:text="${projet.responsable?.nomComplet ?: '-'}">-</td>
            <td class="text-sm font-mono"
                th:text="${projet.budgetEstime != null ? #numbers.formatDecimal(projet.budgetEstime,1,'POINT',0,'COMMA') + ' F' : '-'}">-</td>
            <td>
              <div class="flex gap-2">
                <a th:href="@{/projets/{id}/modifier(id=${projet.id})}" class="btn btn-primary btn-sm">âœï¸</a>
                <sec:authorize access="hasRole('ADMIN')">
                  <form th:action="@{/projets/{id}/supprimer(id=${projet.id})}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-danger btn-sm"
                            data-confirm="Supprimer ce projet ?">ğŸ—‘ï¸</button>
                  </form>
                </sec:authorize>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</content>
</th:block>

<script>
// Toggle views
document.getElementById('viewGrid')?.addEventListener('click', () => {
  document.getElementById('viewGridContent').style.display = '';
  document.getElementById('viewListContent').style.display = 'none';
});
document.getElementById('viewList')?.addEventListener('click', () => {
  document.getElementById('viewGridContent').style.display = 'none';
  document.getElementById('viewListContent').style.display = '';
});
</script>

</body>
</html>

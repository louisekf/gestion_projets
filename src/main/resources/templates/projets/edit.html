<!DOCTYPE html>
<html lang="fr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<body>

<th:block th:replace="~{fragments/layout :: page(title='Modifier le projet', content=~{::content})}">
  <content>

    <div class="breadcrumb">
      <a th:href="@{/dashboard}">Accueil</a>
      <span class="separator">â€º</span>
      <a th:href="@{/projets}">Projets</a>
      <span class="separator">â€º</span>
      <a th:href="@{/projets/{id}(id=${projetId})}">Projet</a>
      <span class="separator">â€º</span>
      <span class="current">Modifier</span>
    </div>

    <div style="max-width: 820px;">

      <div class="flex-between mb-4">
        <div>
          <h2 style="font-family:var(--font-display);font-size:22px;font-weight:700">Modifier le projet</h2>
          <p class="text-muted text-sm mt-1">Mettez Ã  jour les informations du projet</p>
        </div>
      </div>

      <form th:action="@{/projets/{id}(id=${projetId})}" method="post" th:object="${projetRequest}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- Section: Informations gÃ©nÃ©rales -->
        <div class="card mb-4">
          <div class="card-header">
            <span class="card-title">ðŸ“‹ Informations gÃ©nÃ©rales</span>
          </div>
          <div class="card-body">

            <div class="form-group">
              <label class="form-label" for="titre">Titre du projet <span class="required">*</span></label>
              <input type="text" id="titre" th:field="*{titre}"
                     class="form-control" th:classappend="${#fields.hasErrors('titre')} ? 'is-invalid'"
                     placeholder="Ex: DÃ©veloppement d'un systÃ¨me..."/>
              <div class="invalid-feedback" th:if="${#fields.hasErrors('titre')}">
                âš  <span th:errors="*{titre}"></span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="description">Description</label>
              <textarea id="description" th:field="*{description}"
                        class="form-control" rows="4"
                        placeholder="Objectifs, mÃ©thodologie, rÃ©sultats attendus..."></textarea>
            </div>

            <div class="form-row">
              <div class="form-group mb-0">
                <label class="form-label" for="domaineId">Domaine de recherche <span class="required">*</span></label>
                <select id="domaineId" th:field="*{domaineId}"
                        class="form-control form-select">
                  <option value="">-- SÃ©lectionner --</option>
                  <option th:each="d : ${domaines}"
                          th:value="${d.id}"
                          th:text="${d.nom}">Domaine</option>
                </select>
              </div>
              <div class="form-group mb-0">
                <label class="form-label" for="institution">Institution</label>
                <input type="text" id="institution" th:field="*{institution}"
                       class="form-control" placeholder="Ex: UniversitÃ© de Dakar, IRD, CNRS..."/>
              </div>
            </div>

          </div>
        </div>

        <!-- Section: Planification -->
        <div class="card mb-4">
          <div class="card-header">
            <span class="card-title">ðŸ“… Planification & Statut</span>
          </div>
          <div class="card-body">

            <div class="form-row">
              <div class="form-group mb-0">
                <label class="form-label" for="dateDebut">Date de dÃ©but</label>
                <input type="date" id="dateDebut" name="dateDebut" class="form-control"
                       th:value="${projetRequest.dateDebut != null ? #temporals.format(projetRequest.dateDebut, 'yyyy-MM-dd') : ''}"/>
              </div>
              <div class="form-group mb-0">
                <label class="form-label" for="dateFin">Date de fin prÃ©vue</label>
                <input type="date" id="dateFin" name="dateFin" class="form-control"
                       th:value="${projetRequest.dateFin != null ? #temporals.format(projetRequest.dateFin, 'yyyy-MM-dd') : ''}"/>
              </div>
            </div>

            <div class="form-row mt-4">
              <div class="form-group mb-0">
                <label class="form-label" for="statut">Statut</label>
                <select id="statut" th:field="*{statut}" class="form-control form-select">
                  <option value="PLANIFIE">PlanifiÃ©</option>
                  <option value="EN_COURS">En cours</option>
                  <option value="SUSPENDU">Suspendu</option>
                  <option value="TERMINE">TerminÃ©</option>
                  <option value="ANNULE">AnnulÃ©</option>
                </select>
              </div>
              <div class="form-group mb-0">
                <label class="form-label" for="budgetEstime">Budget estimÃ© (FCFA)</label>
                <input type="number" id="budgetEstime" th:field="*{budgetEstime}"
                       class="form-control" min="0" step="1000"/>
              </div>
            </div>

            <div class="form-group mt-4 mb-0">
              <label class="form-label">
                Niveau d'avancement : <strong id="avancementLabel">0%</strong>
              </label>
              <input type="range" id="niveauAvancement" th:field="*{niveauAvancement}"
                     min="0" max="100" step="5" class="w-100"
                     style="accent-color:var(--primary);cursor:pointer;height:6px"/>
              <div class="flex-between text-sm text-muted mt-1">
                <span>0%</span><span>50%</span><span>100%</span>
              </div>
            </div>

          </div>
        </div>

        <!-- Responsable (MANAGER/ADMIN) -->
        <th:block th:if="${isManagerOrAdmin}">
          <div class="card mb-4">
            <div class="card-header">
              <span class="card-title">ðŸ‘¥ Affectation</span>
            </div>
            <div class="card-body">
              <div class="form-group mb-0">
                <label class="form-label" for="responsableId">Responsable</label>
                <select id="responsableId" th:field="*{responsableId}" class="form-control form-select">
                  <option value="">-- Conserver responsable actuel --</option>
                  <option th:each="u : ${users}"
                          th:value="${u.id}"
                          th:text="${u.nomComplet + ' (' + u.email + ')'}">Utilisateur</option>
                </select>
              </div>
            </div>
          </div>
        </th:block>

        <!-- Buttons -->
        <div class="flex gap-3">
          <button type="submit" class="btn btn-accent btn-lg">ðŸ’¾ Enregistrer</button>
          <a th:href="@{/projets/{id}(id=${projetId})}" class="btn btn-outline btn-lg">Annuler</a>
        </div>

      </form>
    </div>

  </content>
</th:block>

</body>
</html>